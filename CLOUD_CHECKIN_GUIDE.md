# 云朵打卡功能使用指南

## 新增功能概述

云朵打卡机器人现在具备了强大的数据记录和统计功能！🌤️

### 🆕 新增功能特性

1. **智能云彩识别** - 使用AI技术识别不同类型的云朵（积云、层云、卷云等）
2. **用户打卡记录** - 自动记录每位用户的云朵打卡历史
3. **云彩类型统计** - 追踪用户发现的各种云彩类型及数量
4. **排行榜系统** - 全球云彩类型排行榜和活跃用户排行榜
5. **个人报告** - 为每位用户生成详细的打卡统计报告
6. **测试模式增强** - 测试模式也会记录打卡数据，方便功能验证和数据积累
7. **🎨 集章册纪念图** - 自动为用户生成精美的集章册风格打卡纪念图

## 🗄️ 数据存储

所有打卡数据都存储在本地轻量化的Level数据库中，位于 `data/cloud-checkins` 目录。

### 数据结构

- **用户打卡记录**: 包含动态ID、时间戳、云彩类型、图片数量、AI分析结果
- **云彩类型数据**: 云朵类型名称、识别置信度、描述信息
- **用户统计**: 总打卡次数、发现的云彩种类、首次和最后打卡时间等

## 🚀 使用方法

### 启动机器人（标准模式）
```bash
npm start
```

### 测试模式（不发布评论，但计入打卡统计）
```bash
npm start -- --test
```
⚠️ **注意**: 测试模式现在也会将云朵分析结果记录到数据库中，方便测试时积累打卡数据。

### 查询用户打卡统计（含纪念图生成）
```bash
npm start -- --stats --user <用户ID>
```
🖼️ **自动生成集章册**: 查询统计时会自动为用户生成一张精美的集章册风格纪念图，展示15种专业云彩类型的收集进度，包含手工印章效果，保存在 `data/images/` 目录中。

### 查看全局统计信息
```bash
npm start -- --global
```

### 显示帮助信息
```bash
npm start -- --help
```

## 🧪 测试模式示例输出

当使用 `npm start -- --test` 时，会看到类似以下的输出：

```
=== 开始云朵分析 ===
=== 检测到 2 种云彩类型 ===
☁️  积云 (置信度: 0.85)
☁️  卷云 (置信度: 0.72)

=== 生成的comment内容 ===
"哇！这天空中的积云好像棉花糖一样蓬松呢～✨"

=== 保存打卡记录到数据库 ===
✅ 用户 123456789 的云朵打卡记录已保存到数据库
📊 用户当前统计: 总打卡 3 次, 发现 5 种云彩

=== 测试完成 ===
注意：在测试模式下，comment不会被实际发布，但打卡数据已记录到数据库
```

## 🎨 集章册打卡功能

### 集章册特色

每张集章册都包含以下精美元素：

- **📘 专业集章册设计** - 模仿真实集章册的经典蓝白配色，具有纸张纹理背景
- **🏷️ 15种专业云彩类型** - 包含积云、层云、卷云、积雨云、高积云、高层云、卷积云、卷层云、层积云、雨层云、塔状积云、荚状云、乳状云、碎层云、漏斗云等完整的气象学分类
- **✅ 手动印章效果** - 已打卡的云彩类型显示手工盖章效果，包含随机位置偏移、旋转角度和不规则边缘
- **⭕ 虚线占位** - 未打卡的类型显示虚线圆圈，激励收集完整
- **🔢 立体计数徽章** - 右上角红色立体徽章显示该云彩类型的打卡次数
- **🎯 进度可视化** - 3行5列布局，一目了然地看到15种云彩的收集进度
- **📄 证书级品质** - 正式的证书风格布局，具有收藏和纪念价值
- **🖼️ 高清输出** - 900x700像素高分辨率，适合打印和数字收藏

### 集章册规格

- **尺寸**: 900x700 像素（横版布局，3行5列）
- **格式**: PNG（高质量）
- **文件命名**: `checkin_<用户ID>_<时间戳>.png`
- **保存位置**: `data/images/` 目录

### 15种专业云彩类型

本集章册包含完整的气象学云彩分类，涵盖高、中、低各层和特殊云彩：

## 🌤️ 世界气象组织(WMO)标准云属分类

基于WMO国际云图集的10个基本云属：

**高云族 (5-13公里)**
1. **卷云 (Cirrus - Ci)** 🌤️ - 纤维状高空冰晶云
2. **卷积云 (Cirrocumulus - Cc)** 🌨️ - 高空小波浪状云
3. **卷层云 (Cirrostratus - Cs)** 🌫️ - 高空薄层云

**中云族 (2-7公里)**
4. **高积云 (Altocumulus - Ac)** ⛅ - 中层波状或团状云
5. **高层云 (Altostratus - As)** 🌥️ - 中层灰色薄层云

**低云族 (0-2公里)**
6. **层积云 (Stratocumulus - Sc)** ⛅ - 低层波状或团块云
7. **层云 (Stratus - St)** 🌫️ - 低层均匀灰色云
8. **积云 (Cumulus - Cu)** ☁️ - 蓬松的白色堆积云
9. **积雨云 (Cumulonimbus - Cb)** ⛈️ - 雷暴云，可达对流层顶

**降水云**
10. **雨层云 (Nimbostratus - Ns)** 🌧️ - 带来持续降水的厚层云

### 集章册效果示例 (WMO标准10种云属)

```
┌─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ┐
│                          #云有所伊 集章册 (WMO标准)                    │
│        用户：test_user_123456    总打卡：28次    时间：2024/01/01~15    │
│                                                                       │
│  【高云族】                                                            │
│   🌤️      🌨️      🌫️                                             │
│  [⭕]³    [🔘]°    [🔘]°                                          │
│   卷云     卷积云    卷层云                                           │
│                                                                       │  
│  【中云族】                                                            │
│   ⛅      🌥️                                                      │
│  [⭕]⁵    [🔘]°                                                   │
│  高积云    高层云                                                     │
│                                                                       │
│  【低云族】                                                            │
│   ⛅      🌫️      ☁️      ⛈️                                     │
│  [⭕]⁴    [🔘]°    [⭕]⁸    [🔘]°                                │
│  层积云     层云      积云     积雨云                                  │
│                                                                       │
│  【降水云】                                                            │
│   🌧️                                                              │
│  [🔘]°                                                             │
│  雨层云                                                              │
│    8       4                 1                                      │
│                                                                       │
│   🌥️      🌨️      🌫️      ⛅      🌧️                            │
│  [⭕]     [🔘]°    [⭕]     [🔘]°    [⭕]                           │
│  高层云    卷积云    卷层云    层积云    雨层云                         │
│            2                 3                                      │
│                                                                       │
│   🌩️      🪩      ☁️      🌪️      🌪️                            │
│  [🔘]°    [⭕]     [🔘]°    [⭕]     [🔘]°                          │
│ 塔状积云   荚状云    乳状云    碎层云   漏斗云                          │
│    5                 6                 1                           │
│                                                                       │
│                                              云朵打卡机器人          │
│                                         2024/01/15 14:30:25        │
└─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ┘

说明：
🔘° = 已完成打卡（手工印章效果：不规则边缘 + 随机偏移旋转）
⭕  = 未完成打卡（虚线圆圈占位）
数字 = 该云彩类型的打卡次数（右上角红色徽章）
```

## 📊 统计报告示例

### 用户个人报告
```
🌤️ 用户123456 的云朵打卡报告

📊 总打卡次数: 15 次
📸 总图片数: 42 张
📅 打卡天数: 7 天
🏆 发现云彩种类: 8 种

☁️ 最常见的云彩类型:
🥇 积云: 8 次
🥈 层云: 4 次
🥉 卷云: 3 次
```

### 全局排行榜
```
☁️ 全球云彩类型排行榜:
🥇 积云: 156 次
🥈 层云: 89 次
🥉 高积云: 67 次

🏆 活跃用户排行榜:
🥇 用户123456: 15 次打卡, 8 种云彩
🥈 用户789012: 12 次打卡, 6 种云彩
🥉 用户345678: 10 次打卡, 7 种云彩
```

## 🤖 自动识别的云彩类型

机器人可以识别以下云彩类型：

- **积云 (Cumulus)** - 蓬松白云
- **层云 (Stratus)** - 覆盖天空的灰色云层
- **卷云 (Cirrus)** - 高空丝状云
- **积雨云 (Cumulonimbus)** - 雷暴云
- **高积云 (Altocumulus)** - 中高度块状云
- **高层云 (Altostratus)** - 中高度层状云
- **卷积云 (Cirrocumulus)** - 高空小块云
- **卷层云 (Cirrostratus)** - 高空薄层云
- **层积云 (Stratocumulus)** - 低空块状云
- **雨层云 (Nimbostratus)** - 降雨云层

## 🔧 技术实现

- **数据库**: Level.js 轻量化KV数据库
- **AI分析**: OpenAI兼容API，支持图像识别
- **图像生成**: HTML + Puppeteer，支持高质量PNG输出
- **数据持久化**: 本地存储，支持备份和恢复
- **性能优化**: 批量处理，内存高效
- **跨平台**: 支持Windows、macOS、Linux

## 📝 注意事项

1. 数据库文件位于 `data/` 目录，建议定期备份
2. 首次运行会自动创建数据库文件
3. 用户ID从动态数据中自动提取
4. 只有包含"云有所伊"话题的图片动态才会被记录
5. 每位用户最多保留最近100条打卡记录
6. **测试模式也会计入统计** - 使用 `--test` 参数时，虽然不发布评论，但会记录打卡数据
7. **专业集章册自动生成** - 查询用户统计时会在 `data/images/` 目录生成包含15种云彩类型和手工印章效果的集章册风格PNG图片

## 🔮 未来功能计划

- [ ] 天气趋势分析
- [ ] 地理位置云彩分布
- [ ] 用户成就系统
- [ ] 数据导出功能
- [ ] Web界面展示

## 🐛 故障排除

如果遇到问题：

1. 检查 `data/` 目录权限
2. 确认OpenAI API配置正确
3. 查看控制台错误日志
4. 重新启动机器人 